# =============================================================================
# AI SkiCoach 环境配置示例
# =============================================================================
# 使用说明：
# 1. 复制此文件为 .env
# 2. 根据实际环境修改配置值
# 3. 不要将 .env 文件提交到版本控制系统
# =============================================================================

# =============================================================================
# 项目基础配置
# =============================================================================
PROJECT_NAME="HeyGO AI SkiCoach Backend"
STACK_NAME=heygo-ai-skicoach
ENVIRONMENT=local  # local, staging, production

# 域名配置
DOMAIN=localhost
FRONTEND_HOST=http://localhost:5173

# =============================================================================
# 安全配置（生产环境必须修改）
# =============================================================================
SECRET_KEY=changethis  # 生产环境请使用 openssl rand -hex 32 生成
FIRST_SUPERUSER=13800138000  # 超级管理员手机号
FIRST_SUPERUSER_PASSWORD=changethis  # 生产环境请使用强密码

# =============================================================================
# 数据库配置
# =============================================================================
POSTGRES_SERVER=localhost  # Docker 环境使用 db
POSTGRES_PORT=5432
POSTGRES_DB=app
POSTGRES_USER=postgres
POSTGRES_PASSWORD=changethis  # 生产环境请使用强密码

# =============================================================================
# Redis 配置
# =============================================================================
REDIS_URL=redis://localhost:6379/0  # Docker 环境使用 redis://redis:6379/0

# =============================================================================
# CORS 配置
# =============================================================================
BACKEND_CORS_ORIGINS="http://localhost,http://localhost:5173,https://localhost,https://localhost:5173"

# =============================================================================
# 邮件服务配置（可选）
# =============================================================================
SMTP_HOST=
SMTP_USER=
SMTP_PASSWORD=
EMAILS_FROM_EMAIL=info@example.com
SMTP_TLS=True
SMTP_SSL=False
SMTP_PORT=587

# =============================================================================
# 短信服务配置（验证码）
# =============================================================================
SMS_SERVICE=mock  # mock, aliyun, tencent
SMS_ACCESS_KEY=
SMS_SECRET_KEY=
SMS_SIGN_NAME=AI滑雪教练
SMS_TEMPLATE_CODE=

# =============================================================================
# 监控配置（可选）
# =============================================================================
SENTRY_DSN=

# =============================================================================
# Docker 配置
# =============================================================================
DOCKER_IMAGE_BACKEND=backend
DOCKER_IMAGE_FRONTEND=frontend
TAG=latest

# =============================================================================
# 生产环境性能优化配置
# =============================================================================

# -----------------------------------------------------------------------------
# Gunicorn 应用服务器配置
# -----------------------------------------------------------------------------
# Worker 数量（留空则自动计算：2 × CPU核心数 + 1）
# GUNICORN_WORKERS=9  # 4核 CPU 推荐值

# Worker 连接数（每个 worker 的最大并发连接）
GUNICORN_WORKER_CONNECTIONS=1000

# Worker 重启配置（防止内存泄漏）
GUNICORN_MAX_REQUESTS=1000  # 处理多少请求后重启 worker
GUNICORN_MAX_REQUESTS_JITTER=50  # 重启时间随机抖动

# 超时配置
GUNICORN_TIMEOUT=120  # 请求超时时间（秒）
GUNICORN_KEEPALIVE=5  # 保持连接时间（秒）
GUNICORN_GRACEFUL_TIMEOUT=30  # 优雅关闭超时（秒）

# 日志级别
GUNICORN_LOG_LEVEL=info  # debug, info, warning, error, critical

# -----------------------------------------------------------------------------
# 数据库连接池配置
# -----------------------------------------------------------------------------
# 连接池大小（建议：worker数量 × 2）
DB_POOL_SIZE=20

# 超出连接池的临时连接数
DB_MAX_OVERFLOW=10

# 连接超时时间（秒）
DB_POOL_TIMEOUT=30

# 连接回收时间（秒，防止数据库端超时）
DB_POOL_RECYCLE=3600

# 使用前 ping 检测连接（建议启用）
DB_POOL_PRE_PING=True

# 是否打印 SQL 语句（生产环境建议关闭）
DB_ECHO=False

# -----------------------------------------------------------------------------
# TimescaleDB 数据压缩配置
# -----------------------------------------------------------------------------
# 多少天后压缩历史数据（建议 3-14 天）
TIMESCALE_COMPRESS_AFTER_DAYS=7

# 压缩分段字段（通常按会话分段）
TIMESCALE_COMPRESS_SEGMENT_BY=session_id

# 压缩排序字段
TIMESCALE_COMPRESS_ORDER_BY="timestamp DESC"

# -----------------------------------------------------------------------------
# TimescaleDB 数据保留策略
# -----------------------------------------------------------------------------
# 传感器原始数据保留天数（IMU/GPS/气压数据）
TIMESCALE_RETENTION_SENSOR_DATA_DAYS=365  # 1 年

# 处理后的指标数据保留天数
TIMESCALE_RETENTION_METRICS_DATA_DAYS=730  # 2 年

# -----------------------------------------------------------------------------
# TimescaleDB 连续聚合配置
# -----------------------------------------------------------------------------
# 连续聚合视图刷新间隔（小时）
TIMESCALE_REFRESH_INTERVAL_HOURS=1

# 刷新窗口配置
TIMESCALE_REFRESH_START_OFFSET_HOURS=3  # 开始偏移量
TIMESCALE_REFRESH_END_OFFSET_HOURS=1    # 结束偏移量

# -----------------------------------------------------------------------------
# PostgreSQL 性能参数（docker-compose.yml 使用）
# -----------------------------------------------------------------------------
# 最大连接数
POSTGRES_MAX_CONNECTIONS=200

# 内存配置（根据服务器内存调整）
# 2GB 内存服务器配置示例：
POSTGRES_SHARED_BUFFERS=256MB        # 服务器内存的 25%
POSTGRES_EFFECTIVE_CACHE_SIZE=1GB    # 服务器内存的 50-75%
POSTGRES_WORK_MEM=10MB               # 排序/哈希操作内存
POSTGRES_MAINTENANCE_WORK_MEM=128MB  # 维护操作内存

# 4GB 内存服务器配置示例：
# POSTGRES_SHARED_BUFFERS=1GB
# POSTGRES_EFFECTIVE_CACHE_SIZE=3GB
# POSTGRES_WORK_MEM=16MB
# POSTGRES_MAINTENANCE_WORK_MEM=256MB

# WAL（预写日志）配置
POSTGRES_WAL_BUFFERS=16MB
POSTGRES_MIN_WAL_SIZE=1GB
POSTGRES_MAX_WAL_SIZE=4GB

# 并行查询配置
POSTGRES_MAX_WORKER_PROCESSES=8           # 最大后台进程数
POSTGRES_MAX_PARALLEL_WORKERS=8           # 最大并行工作进程
POSTGRES_MAX_PARALLEL_WORKERS_PER_GATHER=4  # 每个查询的最大并行度

# -----------------------------------------------------------------------------
# 性能监控配置
# -----------------------------------------------------------------------------
# 是否启用慢查询日志
ENABLE_QUERY_LOGGING=False

# 慢查询阈值（毫秒）
SLOW_QUERY_THRESHOLD_MS=1000

# =============================================================================
# 配置说明和推荐值
# =============================================================================
#
# 不同服务器规格的推荐配置：
#
# 【2核 2GB】
# GUNICORN_WORKERS=5
# DB_POOL_SIZE=10
# POSTGRES_SHARED_BUFFERS=256MB
# POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
#
# 【4核 4GB】
# GUNICORN_WORKERS=9
# DB_POOL_SIZE=18
# POSTGRES_SHARED_BUFFERS=1GB
# POSTGRES_EFFECTIVE_CACHE_SIZE=3GB
#
# 【8核 8GB】
# GUNICORN_WORKERS=17
# DB_POOL_SIZE=34
# POSTGRES_SHARED_BUFFERS=2GB
# POSTGRES_EFFECTIVE_CACHE_SIZE=6GB
#
# =============================================================================
