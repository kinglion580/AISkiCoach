# =============================================================================
# 生产环境配置 (Production)
# =============================================================================
# 此文件用于生产环境
# 使用命令切换到此环境：./switch-env.sh production
# ⚠️ 警告：部署前必须修改所有密码和密钥！
# =============================================================================

# =============================================================================
# 项目基础配置
# =============================================================================
PROJECT_NAME="HeyGO AI SkiCoach Backend"
STACK_NAME=heygo-ai-skicoach
ENVIRONMENT=production

# 域名配置（根据实际生产域名修改）
DOMAIN=api.yourdomain.com
FRONTEND_HOST=https://yourdomain.com

# =============================================================================
# 安全配置 ⚠️ 必须修改
# =============================================================================
# 生成强密钥：openssl rand -hex 32
SECRET_KEY=CHANGE_THIS_TO_A_STRONG_RANDOM_KEY_GENERATED_BY_OPENSSL
FIRST_SUPERUSER=13800138000
FIRST_SUPERUSER_PASSWORD=CHANGE_THIS_TO_A_STRONG_PASSWORD

# =============================================================================
# 数据库配置 ⚠️ 必须修改密码
# =============================================================================
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_DB=app
POSTGRES_USER=postgres
POSTGRES_PASSWORD=CHANGE_THIS_TO_A_STRONG_DB_PASSWORD

# =============================================================================
# Redis 配置
# =============================================================================
REDIS_URL=redis://redis:6379/0

# =============================================================================
# CORS 配置
# =============================================================================
BACKEND_CORS_ORIGINS="https://yourdomain.com,https://www.yourdomain.com"

# =============================================================================
# 邮件服务配置
# =============================================================================
SMTP_HOST=smtp.example.com
SMTP_USER=noreply@yourdomain.com
SMTP_PASSWORD=CHANGE_THIS_SMTP_PASSWORD
EMAILS_FROM_EMAIL=noreply@yourdomain.com
SMTP_TLS=True
SMTP_SSL=False
SMTP_PORT=587

# =============================================================================
# 短信服务配置
# =============================================================================
SMS_SERVICE=aliyun  # aliyun 或 tencent
SMS_ACCESS_KEY=YOUR_SMS_ACCESS_KEY
SMS_SECRET_KEY=YOUR_SMS_SECRET_KEY
SMS_SIGN_NAME=AI滑雪教练
SMS_TEMPLATE_CODE=SMS_TEMPLATE_CODE

# =============================================================================
# 监控配置
# =============================================================================
SENTRY_DSN=https://your-sentry-dsn@sentry.io/production-project-id

# =============================================================================
# Docker 配置
# =============================================================================
DOCKER_IMAGE_BACKEND=backend
DOCKER_IMAGE_FRONTEND=frontend
TAG=latest

# =============================================================================
# 生产环境性能配置（4核 4GB 服务器）
# =============================================================================

# Gunicorn 配置（根据 CPU 核心数调整）
# 4核 CPU: (2 × 4) + 1 = 9
# 8核 CPU: (2 × 8) + 1 = 17
GUNICORN_WORKERS=9
GUNICORN_WORKER_CONNECTIONS=1000
GUNICORN_MAX_REQUESTS=1000
GUNICORN_MAX_REQUESTS_JITTER=50
GUNICORN_TIMEOUT=120
GUNICORN_KEEPALIVE=5
GUNICORN_GRACEFUL_TIMEOUT=30
GUNICORN_LOG_LEVEL=warning  # 生产环境使用 warning 级别

# 数据库连接池配置
# pool_size = workers × 2
DB_POOL_SIZE=18
DB_MAX_OVERFLOW=10
DB_POOL_TIMEOUT=30
DB_POOL_RECYCLE=3600
DB_POOL_PRE_PING=True
DB_ECHO=False  # 生产环境关闭 SQL 打印

# TimescaleDB 配置（生产环境保守策略）
TIMESCALE_COMPRESS_AFTER_DAYS=7  # 7天后压缩
TIMESCALE_COMPRESS_SEGMENT_BY=session_id
TIMESCALE_COMPRESS_ORDER_BY="timestamp DESC"

TIMESCALE_RETENTION_SENSOR_DATA_DAYS=365  # 传感器数据保留 1 年
TIMESCALE_RETENTION_METRICS_DATA_DAYS=730  # 指标数据保留 2 年

TIMESCALE_REFRESH_INTERVAL_HOURS=1
TIMESCALE_REFRESH_START_OFFSET_HOURS=3
TIMESCALE_REFRESH_END_OFFSET_HOURS=1

# PostgreSQL 配置（4GB 内存服务器）
# 8GB 服务器建议值：
# POSTGRES_SHARED_BUFFERS=2GB
# POSTGRES_EFFECTIVE_CACHE_SIZE=6GB
# POSTGRES_WORK_MEM=32MB
# POSTGRES_MAINTENANCE_WORK_MEM=512MB
POSTGRES_MAX_CONNECTIONS=200
POSTGRES_SHARED_BUFFERS=1GB
POSTGRES_EFFECTIVE_CACHE_SIZE=3GB
POSTGRES_WORK_MEM=16MB
POSTGRES_MAINTENANCE_WORK_MEM=256MB
POSTGRES_WAL_BUFFERS=16MB
POSTGRES_MIN_WAL_SIZE=1GB
POSTGRES_MAX_WAL_SIZE=4GB
POSTGRES_MAX_WORKER_PROCESSES=8
POSTGRES_MAX_PARALLEL_WORKERS=8
POSTGRES_MAX_PARALLEL_WORKERS_PER_GATHER=4

# 性能监控配置（生产环境关闭详细日志）
ENABLE_QUERY_LOGGING=False
SLOW_QUERY_THRESHOLD_MS=2000

# =============================================================================
# 生产环境检查清单
# =============================================================================
# □ 修改 SECRET_KEY（使用 openssl rand -hex 32 生成）
# □ 修改 FIRST_SUPERUSER_PASSWORD（强密码）
# □ 修改 POSTGRES_PASSWORD（强密码）
# □ 配置 DOMAIN 和 FRONTEND_HOST
# □ 配置 BACKEND_CORS_ORIGINS
# □ 配置 SMTP 邮件服务
# □ 配置 SMS 短信服务
# □ 配置 Sentry 监控
# □ 根据服务器规格调整性能参数
# □ 配置 SSL 证书
# □ 配置备份策略
# =============================================================================
