# =============================================================================
# 开发环境专用 Dockerfile
# =============================================================================
# 特点：
# 1. 使用阿里云镜像源（apt、pip、uv）
# 2. 不复制应用代码，通过 volume 挂载实现热重载
# 3. 轻量级构建，启动速度快
# 4. 安装开发工具（调试、测试）
# =============================================================================

FROM python:3.10-slim

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1

# =============================================================================
# 配置阿里云镜像源
# =============================================================================

# 1. 配置 APT 阿里云镜像源
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# 2. 配置 pip 和 uv 使用阿里云镜像源
ENV UV_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/
ENV PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/
ENV PIP_TRUSTED_HOST=mirrors.aliyun.com

# =============================================================================
# 安装系统依赖
# =============================================================================

RUN apt-get update && apt-get install -y \
    # PostgreSQL 客户端
    libpq-dev \
    postgresql-client \
    # 构建工具
    gcc \
    g++ \
    # 网络工具
    curl \
    wget \
    # 开发工具
    vim \
    git \
    # 清理缓存
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# 安装 uv（Python 包管理器）
# =============================================================================

# 从阿里云镜像拉取 uv
COPY --from=ghcr.nju.edu.cn/astral-sh/uv:0.5.11 /uv /uvx /bin/

# =============================================================================
# 设置工作目录
# =============================================================================

WORKDIR /app

# =============================================================================
# 安装 Python 依赖
# =============================================================================

# 创建虚拟环境目录
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="/app/.venv/bin:$PATH"

# 复制依赖配置文件和代码（构建时需要）
COPY pyproject.toml uv.lock alembic.ini gunicorn_conf.py ./
COPY app ./app
COPY scripts ./scripts
COPY static ./static

# 安装依赖（包括开发依赖）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync

# 安装开发工具（可选）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install \
    ipython \
    ipdb \
    watchdog

# =============================================================================
# 设置 Python 路径
# =============================================================================

ENV PYTHONPATH=/app

# =============================================================================
# 暴露端口
# =============================================================================

EXPOSE 8000

# =============================================================================
# 启动命令（会被 docker-compose 覆盖）
# =============================================================================

# 默认使用带热重载的 Gunicorn
CMD ["gunicorn", "app.main:app", "-c", "gunicorn_conf.py", "--reload"]

# =============================================================================
# 说明：
# 1. 应用代码通过 docker-compose.dev.yml 的 volumes 挂载
# 2. 代码修改会自动触发热重载
# 3. 不需要重新构建镜像
# =============================================================================
